#!/bin/sh

# Copyright (c) 2012-2019
# See LICENSE for details.
#
# Israel Jacquez <mrkotfw@gmail.com>

PROGNAME="${0##*/}"

XORRISO="/usr/bin/xorriso"

OPTIONS="-as mkisofs -quiet -sysid \"SEGA SEGASATURN\" -volid \"\" -volset \"\" -publisher \"SEGA ENTERPRISES, LTD.\" -preparer \"SEGA ENTERPRISES, LTD.\" -appid \"SEGA ENTERPRISES, LTD.\" -iso-level 1 -input-charset iso8859-1 -no-bak -m \".*\" -generic-boot \"IP.BIN\" -abstract \"ABS.TXT\" -biblio \"BIB.TXT\" -copyright \"CPY.TXT\""

TMP1_FILE="$(mktemp "${TMP_FILEDIR}/XXXX")" || panic "Couldn't create file" 1

panic () {
    printf -- "%s: Error: %s\\n" "${PROGNAME}" "${1}" >&2
    exit "${2}"
}

warning() {
    printf -- "%s: Warning: %s\\n" "${PROGNAME}" "${1}" >&2
}

my_readlink() {
    # Not a true implementation of readlink
    printf -- "%s" $(cd $(dirname "${1}") 2>/dev/null && pwd -P && echo "/$(basename ${1})")
}

clean_up () {
    rm -f "${TMP1_FILE}"
}

trap '_exit_code=${?}; clean_up; exit ${_exit_code}' 0
trap 'clean_up; exit 1' HUP INT QUIT ABRT SEGV PIPE

if ! [ ${#} -eq 2 ]; then
    printf -- "Usage: %s cd-directory image-output-name\n" "${PROGNAME}" >&2
    exit 2
fi

[ -n "${YAUL_INSTALL_ROOT}" ] || panic "Undefined YAUL_INSTALL_ROOT (install root directory)" 1
[ -d "${YAUL_INSTALL_ROOT}" ] || panic "Invalid YAUL_INSTALL_ROOT (install root directory) value" 1
[ -x "${XORRISO}" ] || panic "Invalid executable \`${XORRISO}'" 1

directory=$(my_readlink "${1}")
image="${2}"

# Check if the CD directory exists and is a directory
if [ -L "${directory}" ]; then
    panic "${directory}: Directory must not be a symbolic link" 1
fi
if ! [ -d "${directory}" ]; then
    panic "${directory}: Directory does not exist" 1
fi
if ! [ -r "${directory}" ]; then
    panic "${directory}: Directory is not readable" 1
fi
if ! [ -x "${directory}" ]; then
    panic "${directory}: Directory is inaccessible" 1
fi

# Check if all the files are present
for file in "IP.BIN" "${directory}/ABS.TXT" "${directory}/BIB.TXT" "${directory}/CPY.TXT"; do
    # Needs to be portable (alternative to readlink)
    realpath=$(my_readlink "${file}")

    if [ -z "${realpath}" ]; then
        panic "$(basename "${file}"): Unable to dereference symbolic link" 1
    fi

    if [ -d "${realpath}" ]; then
        panic "$(basename "${realpath}"): Not a file" 1
    fi

    if ! [ -f "${realpath}" ]; then
        panic "$(basename "${realpath}"): Does not exist in $(dirname "${realpath}")" 1
    fi

    if ! [ -r "${realpath}" ]; then
        panic "$(basename "${realpath}"): File is not readable" 1
    fi
done
unset realpath

# Check if ${XORRISO} is installed
iso_tool_realpath=$(my_readlink "${XORRISO}")
if ! [ -f "${iso_tool_realpath}" ] && ! [ -L "${iso_tool_realpath}" ]; then
    panic "${XORRISO}: Does not exist" 1
fi

if ! [ -x "${iso_tool_realpath}" ]; then
    panic "${XORRISO}: Not an executable" 1
fi
unset iso_tool_realpath

if ! (eval "${XORRISO}" "${OPTIONS}" -o "${image}.iso" "${directory}*") >"${TMP1_FILE}" 2>&1; then
    panic "Unable to create \"${image}.iso\"
>>>
$(sed -E 's/^/>>> /g' "${TMP1_FILE}")
<<<" 1
fi
cat "${TMP1_FILE}"
clean_up
