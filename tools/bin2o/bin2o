#!/bin/sh

# Copyright (c) 2012-2016
# See LICENSE for details.
#
# Dan Potter
# Israel Jacquez <mrkotfw@gmail.com>

PROGNAME="${0##*/}"
TMPDIR="${TMPDIR:-/tmp}"

SH_ARCH="${YAUL_ARCH_SH_PREFIX}"
AFLAGS="--fatal-warnings --isa=sh2 --big --reduce-memory-overheads"
ARCH="elf32-sh"
DATA_SECTION="rodata"

SH_AS="${YAUL_INSTALL_ROOT}/${SH_ARCH}/bin/${SH_ARCH}-as"
SH_LD="${YAUL_INSTALL_ROOT}/${SH_ARCH}/bin/${SH_ARCH}-ld"
SH_OBJCOPY="${YAUL_INSTALL_ROOT}/${SH_ARCH}/bin/${SH_ARCH}-objcopy"

[ -n "${YAUL_INSTALL_ROOT}" ] || panic "Undefined YAUL_INSTALL_ROOT (install root directory)" 1
[ -d "${YAUL_INSTALL_ROOT}" ] || panic "Invalid YAUL_INSTALL_ROOT (install root directory) value" 1
[ -n "${YAUL_ARCH_SH_PREFIX}" ] || panic "Undefined YAUL_ARCH_SH_PREFIX (tool-chain prefix)" 1
[ -x "${SH_AS}" ] || panic "Invalid executable \`${SH_AS}'" 1
[ -x "${SH_LD}" ] || panic "Invalid executable \`${SH_LD}'" 1
[ -x "${SH_OBJCOPY}" ] || panic "Invalid executable \`${SH_OBJCOPY}'" 1

panic () {
    printf -- "${PROGNAME}: Error: ${1}" >&2
    exit ${2}
}

tmp1="`mktemp "${TMPDIR}/XXXX"`" || panic "Couldn't create file" 1
tmp2="`mktemp "${TMPDIR}/XXXX"`" || panic "Couldn't create file" 1
tmp3="`mktemp "${TMPDIR}/XXXX"`" || panic "Couldn't create file" 1

clean_up () {
    rm -f "${tmp1}" "${tmp2}" "${tmp3}"
    exit 0
}

trap clean_up 0 1 2 9 15

if [ ${#} != 3 ]; then
    printf -- "Usage: ${PROGNAME} input-file symbol-name output-file\n" >&2
    exit 2
fi

input="${1}"
symbol="${2}"
output="${3}"

# Gotta do a different binary target here depending on the target
("${SH_AS}" ${AFLAGS} \
    -o "${tmp3}" || \
    panic "Couldn't assemble file" 1) << EOF
.SECTION ".${DATA_SECTION}"
.ALIGN 2
EOF

cat > "${tmp1}" << EOF
SECTIONS
{
  .${DATA_SECTION} :
  {
     _${symbol} = .;
     *(.data);
     _${symbol}_end = .;
  }
}
EOF

${SH_LD} --no-warn-mismatch --format binary --oformat "${ARCH}" "${input}" \
    --format "${ARCH}" "${tmp3}" \
    -o "${tmp2}" -r -T "${tmp1}" || panic "Couldn't link file" 1

${SH_OBJCOPY} --set-section-flags ".${DATA_SECTION}=alloc,load,data,readonly" \
    "${tmp2}" "${output}" || panic "Couldn't translate object file" 1
